"""
Step 5: ????????????????????????????????? (File Upload)
Create folder with date-project name format, upload multiple files
"""
import streamlit as st
import os
from pathlib import Path
from datetime import datetime

# Imports
from src.shared.project_manager import save_project
from src.frontend.utils import show_back_button, auto_save_project, show_step_guard
from src.config.constants import STEP_VIDEO_PROMPT, STEP_PROJECT, UPLOAD_DIR, DATA_DIR


def _create_upload_folder(project) -> str:
    """Create upload folder with format: YYYYMMDD-project_name"""
    # Format date
    project_date = project.project_date or project.created_at or datetime.now()
    if hasattr(project_date, 'strftime'):
        date_str = project_date.strftime("%Y%m%d")
    else:
        date_str = datetime.now().strftime("%Y%m%d")
    
    # Sanitize project name
    safe_name = "".join(c for c in project.title if c.isalnum() or c in (' ', '-', '_'))
    safe_name = safe_name.strip().replace(' ', '_')[:50]  # Limit length
    
    folder_name = f"{date_str}-{safe_name}"
    
    # Create folder
    upload_path = UPLOAD_DIR / folder_name
    upload_path.mkdir(parents=True, exist_ok=True)
    
    return str(upload_path), folder_name


def render():
    """Step 5: ?????????????????????????????????"""
    # Back button
    if st.button("??? ????????????????????????: ??????????????? Prompt"):
        st.session_state.page = STEP_VIDEO_PROMPT
        st.rerun()
    
    st.title("5?????? ?????????????????????????????????")
    
    if not show_step_guard(4):
        return
    
    project = st.session_state.current_project
    st.caption(f"???? ??????????????????: **{project.title}**")
    
    st.markdown("---")
    
    # ===== FOLDER CREATION =====
    st.subheader("???? ??????????????????????????????????????????")
    
    # Create or get upload folder
    if not project.upload_folder:
        upload_path, folder_name = _create_upload_folder(project)
        project.upload_folder = folder_name
        project.final_video_path = upload_path
        st.session_state.current_project = project
        auto_save_project()
    
    folder_display = project.upload_folder or "??????????????????????????????????????????"
    full_path = UPLOAD_DIR / folder_display if project.upload_folder else None
    
    col_folder, col_action = st.columns([3, 1])
    
    with col_folder:
        st.success(f"??? ????????????????????????: **{folder_display}**")
        if full_path:
            st.caption(f"???? Path: `{full_path}`")
    
    with col_action:
        if st.button("???? ???????????????????????????????????????????????????"):
            upload_path, folder_name = _create_upload_folder(project)
            project.upload_folder = folder_name
            project.final_video_path = upload_path
            st.session_state.current_project = project
            auto_save_project()
            st.rerun()
    
    st.markdown("---")
    
    # ===== FILE UPLOAD =====
    st.subheader("???? ?????????????????????????????????")
    
    st.info("???? ????????????????????????????????????????????????????????????????????????????????????????????????")
    
    uploaded_files = st.file_uploader(
        "?????????????????????????????????????????????",
        type=["mp4", "webm", "mov", "avi", "mkv"],
        accept_multiple_files=True,
        key="step5_upload"
    )
    
    if uploaded_files:
        # Ensure folder exists
        if not full_path or not full_path.exists():
            upload_path, folder_name = _create_upload_folder(project)
            project.upload_folder = folder_name
            full_path = Path(upload_path)
        
        st.markdown("**???? ????????????????????????????????????...**")
        progress_bar = st.progress(0)
        
        saved_files = []
        for i, uploaded_file in enumerate(uploaded_files):
            # Save file
            file_path = full_path / uploaded_file.name
            
            with open(file_path, "wb") as f:
                f.write(uploaded_file.getvalue())
            
            saved_files.append(str(file_path))
            
            # Update progress
            progress_bar.progress((i + 1) / len(uploaded_files))
        
        # Update project
        if not project.uploaded_files:
            project.uploaded_files = []
        project.uploaded_files.extend(saved_files)
        project.uploaded_files = list(set(project.uploaded_files))  # Remove duplicates
        
        st.session_state.current_project = project
        auto_save_project()
        
        st.success(f"??? ??????????????????????????????????????? {len(uploaded_files)} ????????????!")
    
    st.markdown("---")
    
    # ===== UPLOADED FILES LIST =====
    st.subheader("???? ??????????????????????????????????????????????????????")
    
    if project.uploaded_files:
        for i, file_path in enumerate(project.uploaded_files):
            file_name = Path(file_path).name
            file_exists = os.path.exists(file_path)
            
            col_file, col_status, col_delete = st.columns([4, 1, 1])
            
            with col_file:
                icon = "???" if file_exists else "???"
                st.markdown(f"{icon} **{file_name}**")
            
            with col_status:
                if file_exists:
                    file_size = os.path.getsize(file_path) / (1024 * 1024)  # MB
                    st.caption(f"{file_size:.1f} MB")
                else:
                    st.caption("???????????????????????????")
            
            with col_delete:
                if st.button("???????", key=f"del_file_{i}"):
                    if file_exists:
                        os.remove(file_path)
                    project.uploaded_files.remove(file_path)
                    st.session_state.current_project = project
                    auto_save_project()
                    st.rerun()
        
        st.markdown("---")
        st.metric("???? ?????????????????????????????????", len(project.uploaded_files))
    else:
        st.info("???? ??????????????????????????????????????????????????????????????????")
    
    # ===== FOLDER CONTENTS =====
    if full_path and full_path.exists():
        with st.expander("???? ?????????????????????????????????????????????????????????????????????"):
            all_files = list(full_path.iterdir())
            if all_files:
                for f in all_files:
                    if f.is_file():
                        size_mb = f.stat().st_size / (1024 * 1024)
                        st.caption(f"???? {f.name} - {size_mb:.1f} MB")
            else:
                st.caption("(???????????????????????????)")
    
    st.markdown("---")
    
    # ===== GOOGLE DRIVE LINK =====
    st.subheader("?????? Google Drive (Optional)")
    
    drive_link = st.text_input(
        "???? ??????????????? Google Drive Folder",
        value=project.drive_folder_link,
        placeholder="https://drive.google.com/drive/folders/...",
        key="step5_drive_link"
    )
    project.drive_folder_link = drive_link
    
    if drive_link:
        st.link_button("???? ???????????? Google Drive", drive_link)
    
    st.markdown("---")

    # ===== VIDEO EDITOR EXPORT (Feature 5) =====
    if project.scenes and any(s.veo_prompt for s in project.scenes):
        st.subheader("??????? Export ?????????????????? Video Editor")
        st.caption("Import timeline ???????????? video editor ???????????????????????? ????????????????????? manual sync")

        try:
            from src.core.exporter import ProjectExporter
            exporter = ProjectExporter()

            col_edl, col_fcp, col_otio, col_bundle = st.columns(4)

            with col_edl:
                edl_content = exporter.export_edl(project)
                st.download_button(
                    "???? EDL\n(Premiere/Resolve)",
                    data=edl_content,
                    file_name=f"{project.title}_timeline.edl",
                    mime="text/plain",
                    use_container_width=True,
                    help="Adobe Premiere Pro, DaVinci Resolve, Final Cut Pro 7",
                )

            with col_fcp:
                fcpxml_content = exporter.export_fcpxml(project)
                st.download_button(
                    "???? FCPXML\n(Final Cut Pro)",
                    data=fcpxml_content,
                    file_name=f"{project.title}_timeline.fcpxml",
                    mime="application/xml",
                    use_container_width=True,
                    help="Final Cut Pro X / Motion",
                )

            with col_otio:
                otio_content = exporter.export_otio_json(project)
                st.download_button(
                    "???? OTIO JSON\n(Universal)",
                    data=otio_content,
                    file_name=f"{project.title}_timeline.json",
                    mime="application/json",
                    use_container_width=True,
                    help="OpenTimelineIO ??? import via adapter in any NLE",
                )

            with col_bundle:
                bundle_bytes = exporter.export_editor_bundle(project)
                st.download_button(
                    "???? Bundle ZIP\n(?????????????????????)",
                    data=bundle_bytes,
                    file_name=f"{project.title}_editor_bundle.zip",
                    mime="application/zip",
                    use_container_width=True,
                    help="EDL + FCPXML + OTIO + README ?????????????????????????????????",
                )

            st.success(f"??? Timeline ??????????????? Export ({len(project.scenes)} scenes / {project.total_duration:.1f}s)")

        except Exception as e:
            st.error(f"??? Export ???????????????????????????: {e}")

        st.markdown("---")


    col_save, col_complete = st.columns(2)
    
    with col_save:
        if st.button("???? ??????????????????", use_container_width=True):
            project.status = "step5_upload"
            project.workflow_step = 4
            st.session_state.current_project = project
            save_project(project)
            st.success("??? ????????????????????????????????????!")
    
    with col_complete:
        if st.button("???? ?????????????????????????????????????????????", type="primary", use_container_width=True):
            project.status = "completed"
            project.workflow_step = 5
            project.updated_at = datetime.now()
            st.session_state.current_project = project
            save_project(project)
            
            st.balloons()
            st.success("???? ?????????! ??????????????????????????????????????????????????????!")
            
            # Option to create new project
            if st.button("??? ?????????????????????????????????????????????"):
                st.session_state.current_project = None
                st.session_state.page = STEP_PROJECT
                st.rerun()
    
    # Show completion summary
    if project.status == "completed":
        st.markdown("---")
        st.subheader("???? ??????????????????????????????")
        
        col1, col2, col3 = st.columns(3)
        
        with col1:
            st.metric("???? ??????????????????????????????", len(project.scenes) if project.scenes else 0)
        
        with col2:
            st.metric("???? ?????????????????????????????????", len(project.uploaded_files) if project.uploaded_files else 0)
        
        with col3:
            duration = sum(s.audio_duration for s in project.scenes) if project.scenes else 0
            st.metric("?????? ??????????????????????????????", f"{duration:.1f}s")
