# ===============================================================
# Strategy Engine — Cloud Run Service Definition (Backend API)
# Deploy: gcloud run services replace deploy/cloudrun-api.yaml
# ===============================================================

apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  name: strategy-engine-api
  annotations:
    run.googleapis.com/ingress: all

spec:
  template:
    metadata:
      annotations:
        # Scale to zero for cost efficiency; max 10 instances
        run.googleapis.com/min-scale: "0"
        run.googleapis.com/max-scale: "10"
        # Firestore is accessed via Application Default Credentials (no proxy needed)
        # run.googleapis.com/vpc-access-connector: projects/PROJECT_ID/locations/REGION/connectors/CONNECTOR_NAME
    spec:
      serviceAccountName: strategy-engine-sa@PROJECT_ID.iam.gserviceaccount.com
      containers:
        - image: REGION-docker.pkg.dev/PROJECT_ID/strategy-engine/api:latest
          ports:
            - containerPort: 8080

          # CPU/Memory (adjust based on load)
          resources:
            limits:
              cpu: "1"
              memory: 1Gi
            requests:
              cpu: "0.25"
              memory: 256Mi

          # Startup probe — wait for Alembic to finish before taking traffic
          startupProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 10
            failureThreshold: 10
            periodSeconds: 5

          # Liveness probe
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 30
            periodSeconds: 30

          env:
            # === Secrets from Secret Manager (individual secrets) ===
            - name: OPENAI_API_KEY
              valueFrom:
                secretKeyRef:
                  name: strategy-engine-openai-api-key
                  key: latest
            - name: DEEPSEEK_API_KEY
              valueFrom:
                secretKeyRef:
                  name: strategy-engine-deepseek-api-key
                  key: latest
            - name: FIREBASE_PROJECT_ID
              value: "vdo-content-4e158"
            - name: PRODUCTION_WEBHOOK_URL
              valueFrom:
                secretKeyRef:
                  name: strategy-engine-production-webhook-url
                  key: latest
            - name: PRODUCTION_WEBHOOK_TOKEN
              valueFrom:
                secretKeyRef:
                  name: strategy-engine-production-webhook-token
                  key: latest
            - name: QDRANT_URL
              valueFrom:
                secretKeyRef:
                  name: strategy-engine-qdrant-url
                  key: latest
            # Optional — omit if not using DataForSEO
            # - name: DATAFORSEO_LOGIN
            #   valueFrom:
            #     secretKeyRef:
            #       name: strategy-engine-dataforseo-login
            #       key: latest
            # - name: DATAFORSEO_PASSWORD
            #   valueFrom:
            #     secretKeyRef:
            #       name: strategy-engine-dataforseo-password
            #       key: latest
            # === Non-sensitive env vars ===
            - name: DEBUG
              value: "false"
            - name: CORS_ORIGINS
              value: '["https://strategy-ui-xxxx.run.app"]'

